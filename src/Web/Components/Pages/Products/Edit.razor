@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject DialogService DialogService
@using Data.Models
@using Microsoft.EntityFrameworkCore

<RadzenTemplateForm TItem="Product" Data="@Product" Submit="Submit">
  <RadzenRow Gap="2rem" Class="rz-p-0 rz-p-lg-4">
    <RadzenColumn Size="12">
      <RadzenFieldset Text="Produkt Info">
        <RadzenStack Gap="1rem">

          <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Name" Component="Name" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenTextBox @bind-Value="Product.Name" Style="width: 100%;" Name="Name" />
            </RadzenColumn>
          </RadzenRow>

          <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Preis" Component="Price" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenNumeric @bind-Value="Product.Price" Style="width: 100%;" Name="Price" />
            </RadzenColumn>
          </RadzenRow>

          <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Beschreibung" Component="Description" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenTextArea @bind-Value="Product.Description" Style="width: 100%;" Name="Description" />
            </RadzenColumn>
          </RadzenRow>

          <RadzenRow AlignItems="AlignItems.Center">

            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Tags" Component="Tags" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenStack Gap="0.5rem">
                <TagList Product="Product" />
              </RadzenStack>
            </RadzenColumn>
          </RadzenRow>

          <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Breite (in px)" Component="Width" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenNumeric @bind-Value="Product.Width" Style="width: 100%;" Name="Width" />
            </RadzenColumn>
          </RadzenRow>

          <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Höhe (in px)" Component="Height" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenNumeric @bind-Value="Product.Height" Style="width: 100%;" Name="Height" />
            </RadzenColumn>
          </RadzenRow>

          <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="2">
              <RadzenLabel Text="Bild" Component="Image" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="10">
              <RadzenTextBox @bind-Value="Product.Image" Style="width: 100%;" Name="Image" />
              <RadzenImage Path="@Product.Image" Style="width: 100px; height: auto; margin-top: 1rem;" />
            </RadzenColumn>
          </RadzenRow>

          @if (Product.Comments?.Count > 0) {
            <RadzenRow AlignItems="AlignItems.Center">
              <RadzenColumn Size="12" SizeMD="2">
                <RadzenLabel Text="Sonstiges" />
              </RadzenColumn>

              <RadzenColumn Size="12" SizeMD="10">
                <RadzenButton ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Small" Icon="delete" Text="Alle Kommentare löschen" Click="@DeleteComments" />
              </RadzenColumn>
            </RadzenRow>
          }

        </RadzenStack>
      </RadzenFieldset>
    </RadzenColumn>
  </RadzenRow>

  <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem" Class="rz-mt-8 rz-mb-4">
    <RadzenButton ButtonType="ButtonType.Submit" Size="ButtonSize.Large" Icon="save" Text="Speichern" />
    <RadzenButton ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Large" Icon="cancel" Text="Abbrechen" Click="@Cancel" />
  </RadzenStack>
</RadzenTemplateForm>

@code {
  [Parameter]
  [EditorRequired]
  public Product Product { get; set; } = default!;

  [Parameter]
  [EditorRequired]
  public EventCallback OnSubmit { get; set; }

  /// <summary>
  /// Updates the product in the database and closes the dialog with a true result, which indicates that the product was updated.
  /// </summary>
  async Task Submit() {
    await OnSubmit.InvokeAsync();
    DialogService.Close(true);
  }

  /// <summary>
  /// Closes the dialog with a false result, which indicates that the product was not updated.
  /// </summary>
  void Cancel() {
    DialogService.Close(false);
  }

  /// <summary>
  /// Deletes all comments of the product.
  /// </summary>
  private async Task DeleteComments() {
    bool delete = await DialogService.OpenAsync<DeleteComments>("Alle Komentare löschen",
     new Dictionary<string, object> {
       { "Comments", Product.Comments } // comments cannot be null, because the button is only visible if there are comments
     },
     new DialogOptions() { Resizable = false, Draggable = false, CloseDialogOnOverlayClick = false }
    );

    if (delete)
      Product.Comments.Clear();

    // This is necessary to update the UI -> delete comments btn
    StateHasChanged();
  }
}
